# üéØ Task: Post-Payment Features & Production Polish

**Objective:** Complete the remaining features after the core payment flow is working.
**Priority:** High
**Scope:** Webhook reliability, content generation, admin features, and deployment.

---

## üìã Requirements

### Functional Requirements
- **[REQ-001]** Paystack Webhook Handler - Catch payments even if user closes browser
- **[REQ-002]** Full Chapter Generation - Generate verbose academic content (Chapters 1-3) after payment
- **[REQ-003]** Payment History in Admin - View all transactions
- **[REQ-004]** Email Receipts - Send confirmation after successful payment
- **[REQ-005]** Upsell Bridge - "Stuck? Hire us" button in Builder dashboard

### Technical Requirements
- **[TECH-001]** Webhook signature verification (Paystack HMAC)
- **[TECH-002]** Idempotent webhook processing (handle duplicate events)
- **[TECH-003]** Production environment variables setup
- **[TECH-004]** Vercel deployment configuration

---

## üèóÔ∏è Implementation Plan

### Phase 1: Payment Reliability
- [ ] Create `/api/pay/webhook` route handler
- [ ] Implement Paystack signature verification
- [ ] Handle `charge.success` event
- [ ] Test with Paystack webhook simulator

### Phase 2: Post-Payment Content Generation
- [ ] Create `/api/generate/chapter` endpoint
- [ ] Implement verbose academic content generation prompts
- [ ] Add "Generate Chapter X" buttons in Builder (post-unlock)
- [ ] Store generated chapters in DB (`ChapterOutline` or new table?)

### Phase 3: Code Snippet Generation (Optional - Value Add)
- [ ] Detect project type from topic/abstract
- [ ] Generate relevant code boilerplate (CRUD, Auth, etc.)
- [ ] Display in "Code Snippets" tab

### Phase 4: Admin Enhancements
- [ ] Add `/admin/payments` route
- [ ] List all Payment records with status, user, project
- [ ] Add export to CSV functionality

### Phase 5: Email Integration
- [ ] Choose provider: Resend, Postmark, or SendGrid
- [ ] Create email template for payment receipt
- [ ] Trigger email on successful verification

### Phase 6: The Upsell Bridge
- [ ] Add "Stuck? Hire Us" CTA component
- [ ] Calculate discount (‚Ç¶120k - ‚Ç¶15k already paid)
- [ ] Link to WhatsApp/Consult flow

### Phase 7: Deployment
- [ ] Set up Vercel project
- [ ] Configure environment variables in Vercel Dashboard
- [ ] Set up custom domain (projects.jstar.com or similar)
- [ ] Configure Paystack Live Keys
- [ ] Test full flow in production

---

## üìÅ Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/app/api/pay/webhook/route.ts` | Create | Paystack webhook handler |
| `src/app/api/generate/chapter/route.ts` | Create | Full chapter content generation |
| `src/app/admin/payments/page.tsx` | Create | Payment history dashboard |
| `src/services/email.service.ts` | Create | Email sending logic |
| `src/features/builder/components/ChapterGenerator.tsx` | Create | Post-payment content generation UI |
| `src/features/builder/components/UpsellBridge.tsx` | Create | "Hire us" CTA component |
| `.env.production` | Create | Production environment variables |
| `vercel.json` | Create | Vercel configuration |

---

## ‚úÖ Success Criteria

### Code Quality
- [ ] TypeScript compliant
- [ ] No console errors in production
- [ ] Error handling for all API calls

### Performance
- [ ] Webhook responds in < 200ms
- [ ] Content generation shows loading states
- [ ] Deployed site loads in < 3s

### Functionality
- [ ] User can pay via Paystack (Live mode)
- [ ] Payment persists even if user closes tab (webhook)
- [ ] Generated content is downloadable
- [ ] Admin can view all transactions

---

## üîó Dependencies

**Completed:**
- [x] Better Auth integration
- [x] Paystack payment initialization
- [x] Paystack payment verification
- [x] Project claiming logic
- [x] Zustand persistence

**Related files:**
- `src/services/paystack.service.ts`
- `src/app/api/pay/initialize/route.ts`
- `src/app/api/pay/verify/route.ts`
- `src/features/builder/components/ChapterOutliner.tsx`

---

## üí∞ Pricing Configuration

Current pricing (hardcoded in `/api/pay/initialize`):
```typescript
const PROJECT_UNLOCK_AMOUNT = 15000; // ‚Ç¶15,000
```

**Future consideration:** Move to DB/config for dynamic pricing tiers:
- Basic: ‚Ç¶15,000 (Chapters 1-3 only)
- Premium: ‚Ç¶20,000 (Chapters 1-5 + Code Snippets)

---

## üöÄ Getting Started

1. Read this task prompt completely
2. Start with **Phase 1: Payment Reliability** (Webhook)
3. Provide progress updates after each phase
4. Test each feature before moving to next phase

---

*Generated by /spawn_task workflow*
