# ğŸ¯ Task: Require Auth on Jay â†’ Builder Transition

**Objective:** Require user authentication when transitioning from Jay chat to the Builder page, ensuring all projects are linked to real user accounts.  
**Priority:** High  
**Scope:** Modify chat redirect flow, update localStorage handoff, ensure builder handles authenticated users correctly.

---

## ğŸ“‹ Requirements

### Functional Requirements
- **[REQ-001]** When `confirmTopic` is triggered, redirect to `/auth/register?callbackUrl=/project/builder` instead of `/project/builder`
- **[REQ-002]** After successful auth, user should land on builder with their topic/twist hydrated
- **[REQ-003]** Leads should be linked to `userId` after registration
- **[REQ-004]** Projects created in builder should always have a `userId`

### Technical Requirements
- **[TECH-001]** Update `useChatFlow.tsx` redirect logic
- **[TECH-002]** Ensure `CHAT_HANDOFF_KEY` data includes `userId` after auth
- **[TECH-003]** Update `mergeAnonymousConversations` to run after login

---

## ğŸ—ï¸ Implementation Plan

### Phase 1: Update Chat Redirect
- [x] Modify `useChatFlow.tsx` - change redirect URL to auth with callback
- [x] Store topic/twist in localStorage before redirect (already done via `confirmTopic`)

### Phase 2: Post-Auth Hydration
- [x] Ensure `/auth/register` and `/auth/login` properly redirect to `callbackUrl`
- [x] Verify `BuilderPage` hydrates from localStorage after auth

### Phase 3: Lead Linking
- [x] After successful registration, link lead's `anonymousId` to new `userId`
- [x] Update `saveLeadAction` to update existing leads when userId is available

### Phase 4: Testing
- [ ] Test full flow: Chat â†’ Auth â†’ Builder â†’ Payment
- [ ] Verify lead appears in admin with userId linked

---

## ğŸ“ Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/features/bot/hooks/useChatFlow.tsx` | Modify | Change redirect to auth page |
| `src/app/(saas)/project/builder/page.tsx` | Verify | Ensure post-auth hydration works |
| `src/features/bot/actions/chat.ts` | Modify | Add lead-user linking after auth |
| `src/app/(auth)/auth/register/page.tsx` | Verify | Ensure callbackUrl redirect works |

---

## âœ… Success Criteria

- [ ] Users cannot reach builder without being logged in (after Jay chat)
- [ ] Topic/twist are preserved through auth flow
- [ ] All new projects have `userId` set
- [ ] Leads in admin dashboard show linked user accounts
- [ ] Payment verification works seamlessly

---

## ğŸ”— Related Files

- `src/features/bot/hooks/useChatFlow.tsx` - Main redirect logic
- `src/features/builder/store/useBuilderStore.ts` - Handoff data store
- `src/features/bot/actions/chat.ts` - Lead saving logic
- `src/lib/auth-client.ts` - Client-side auth utilities

---

## ğŸš€ Getting Started

1. Read this task prompt completely
2. Review `useChatFlow.tsx` for the `confirmTopic` redirect logic
3. Test current flow to understand baseline
4. Implement Phase 1 changes
5. Test and iterate

---

*Generated by /spawn_task workflow*
